<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>自己成長型AIチャット</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* スクロールバーのスタイル（任意） */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body class="flex flex-col h-screen bg-gray-100 font-sans">
    <!-- Header -->
    <header class="bg-white shadow-md p-4 flex justify-between items-center z-10">
        <h1 class="text-xl font-bold text-gray-800">自己成長型AIチャット</h1>
        <div class="flex items-center space-x-4">
            <span id="userIdDisplay" class="text-xs text-gray-500 hidden sm:block">UserID: 読み込み中...</span>
            <button id="deleteButton" class="p-2 rounded-full text-gray-500 hover:bg-red-100 hover:text-red-600 transition-colors" title="記憶を消去">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
            </button>
        </div>
    </header>

    <!-- Chat Area -->
    <main id="chatArea" class="flex-1 overflow-y-auto p-4 md:p-6">
        <div id="messageContainer" class="max-w-4xl mx-auto space-y-6">
            <!-- Messages will be inserted here -->
        </div>
    </main>

    <!-- Input Area -->
    <footer class="bg-white border-t p-4">
        <div class="max-w-4xl mx-auto flex items-center gap-2">
            <input type="text" id="userInput" placeholder="メッセージを入力..." class="w-full p-3 border rounded-full focus:ring-2 focus:ring-blue-500 focus:outline-none transition" />
            <button id="sendButton" class="bg-blue-500 text-white rounded-full p-3 hover:bg-blue-600 disabled:bg-gray-300 transition-colors flex-shrink-0">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send"><line x1="22" x2="11" y1="2" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
            </button>
        </div>
    </footer>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-8 shadow-xl max-w-sm w-full">
            <h2 class="text-lg font-bold mb-4">記憶の消去</h2>
            <p class="text-gray-600 mb-6">これまでの対話履歴と、学習したあなたの特徴をすべて消去します。この操作は元に戻せません。本当に実行しますか？</p>
            <div class="flex justify-end gap-4">
                <button id="cancelDeleteButton" class="px-4 py-2 rounded-md bg-gray-200 hover:bg-gray-300 transition-colors">キャンセル</button>
                <button id="confirmDeleteButton" class="px-4 py-2 rounded-md bg-red-500 text-white hover:bg-red-600 transition-colors">消去する</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, getIdToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Configuration ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-chat-app';
        
        // ★★★ [Google Cloud] 重要 ★★★
        // バックエンド(app.py)をCloud Runなどにデプロイした後、
        // そのサービスの公開URLにこの値を書き換えてください。
        // const BACKEND_URL = 'https://your-backend-service-url.a.run.app';
        const BACKEND_URL = ''; // 同じサーバーなのでホスト名を省略

        // --- DOM Elements ---
        const messageContainer = document.getElementById('messageContainer');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const chatArea = document.getElementById('chatArea');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const deleteButton = document.getElementById('deleteButton');
        const deleteModal = document.getElementById('deleteModal');
        const cancelDeleteButton = document.getElementById('cancelDeleteButton');
        const confirmDeleteButton = document.getElementById('confirmDeleteButton');

        // --- Firebase Initialization ---
        let auth, db, currentUser;

        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase initialization failed:", e);
            messageContainer.innerHTML = '<p class="text-red-500 text-center">Application failed to load.</p>';
        }

        // --- Functions ---
        const scrollToBottom = () => {
            chatArea.scrollTop = chatArea.scrollHeight;
        };

        const createMessageElement = (role, content) => {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex items-start gap-4 ${role === 'user' ? 'justify-end' : 'justify-start'}`;

            const icon = role === 'model' 
                ? `<div class="w-8 h-8 rounded-full bg-indigo-500 flex items-center justify-center text-white flex-shrink-0"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bot"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg></div>`
                : `<div class="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-gray-600 flex-shrink-0"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>`;
            
            const bubble = document.createElement('div');
            bubble.className = `max-w-lg px-4 py-3 rounded-2xl whitespace-pre-wrap ${role === 'user' ? 'bg-blue-500 text-white rounded-br-none' : 'bg-white text-gray-800 shadow-sm rounded-bl-none'}`;
            bubble.textContent = content;

            if (role === 'model') {
                messageWrapper.innerHTML = icon;
                messageWrapper.appendChild(bubble);
            } else {
                messageWrapper.appendChild(bubble);
                messageWrapper.innerHTML += icon;
            }
            return messageWrapper;
        };

        const setLoading = (isLoading) => {
            userInput.disabled = isLoading;
            sendButton.disabled = isLoading;
            sendButton.innerHTML = isLoading 
                ? `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-loader-2 animate-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>`
                : `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send"><line x1="22" x2="11" y1="2" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>`;
        };

        const handleSendMessage = async () => {
            const messageText = userInput.value.trim();
            if (!messageText || !currentUser) return;

            setLoading(true);
            userInput.value = '';

            try {
                if (BACKEND_URL.includes('your-backend-service-url')) {
                    throw new Error('Backend URL is not configured. Please update index.html.');
                }
                const token = await getIdToken(currentUser);
                const response = await fetch(`${BACKEND_URL}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        token: token,
                        message: messageText,
                        appId: appId
                    }),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to communicate with the server.');
                }
            } catch (error) {
                console.error('Send message error:', error);
                messageContainer.appendChild(createMessageElement('model', `Error: ${error.message}`));
            } finally {
                setLoading(false);
            }
        };

        const handleDeleteData = async () => {
            if (!currentUser) return;
            
            try {
                const token = await getIdToken(currentUser);
                const response = await fetch(`${BACKEND_URL}/delete-data`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: token, appId: appId }),
                });

                if (!response.ok) throw new Error('Failed to delete data.');
                
                alert('Data successfully deleted.');
                deleteModal.classList.add('hidden');
            } catch (error) {
                console.error('Delete data error:', error);
                alert(error.message);
            }
        };

        // --- Authentication & Realtime Listener ---
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                userIdDisplay.textContent = `UserID: ${user.uid}`;

                const messagesRef = collection(db, `artifacts/${appId}/users/${user.uid}/messages`);
                const q = query(messagesRef, orderBy("createdAt", "asc"));
                
                onSnapshot(q, (snapshot) => {
                    messageContainer.innerHTML = '';
                    snapshot.forEach(doc => {
                        const msg = doc.data();
                        messageContainer.appendChild(createMessageElement(msg.role, msg.content));
                    });
                    scrollToBottom();
                });
            } else {
                signInAnonymously(auth).catch(error => console.error("Anonymous sign in failed:", error));
            }
        });

        // --- Event Listeners ---
        sendButton.addEventListener('click', handleSendMessage);
        userInput.addEventListener('keypress', (e) => e.key === 'Enter' && handleSendMessage());
        deleteButton.addEventListener('click', () => deleteModal.classList.remove('hidden'));
        cancelDeleteButton.addEventListener('click', () => deleteModal.classList.add('hidden'));
        confirmDeleteButton.addEventListener('click', handleDeleteData);
    </script>
</body>
</html>

